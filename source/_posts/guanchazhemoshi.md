---
title: JS之发布订-阅模式
date: 2016-8-12 22:10:58
tags: js、设计模式
---
#### js设计模式——发布订阅模式
发布订阅模式又叫观察者模式，它定义对象间的一种一对多的依赖关系，当一个对象的状态发生改变时，所有的依赖于它的对象都将得到通知。在js开发中，我们一般用事件模型来代替传统的发布-订阅模式。
##### 现实中的发布—订阅模式
1、烧水例子：只有等水烧开了，才能做后续的事件，比如洗脚，泡茶，泡面等一系列之前安排好的事情。
2、售楼例子：买房者在售楼处留下电话号码，等楼开售时，售楼处会依依通知预留手机号码的人。
##### 发布-订阅模式的作用
一：发布-订阅模式可以广泛地应用在异步编程中，这是一种替代传递回调函数的方案。
二：可以取代对象之间硬编码的通知机制，一个对象不用再显式地调用另外一个对象的某个接口。
优点：一是时间上的解耦，二是对象之间的解耦;
缺点：创建订阅者本身要消耗一定的时间和内存，而且当你订阅一个消息后，也许此消息最后都未发生，但是这个订阅者会始终存在于内存中。另处，虽然发布-订阅模式可以弱化对象之间的联系，但是如果过度使用的话，对象和对象之间的必要联系也将被深埋在背后，会导致程序难以跟踪维护和理解。特别是有多个发布者和订阅者嵌套到一起的时候，要跟踪一个bug是很困难的。
#### dom事件
实际上，只要我们曾经在dom节点上面绑过事件函数，那我们就曾经使用过发布-订阅模式
```
document.body.addEventListener('click',function () {
    alert(2);
},false);
document.body.click();//模拟用户点击
//我们订阅document.body上的click事件，当body节点被点击的时候，body节点会向订阅者发布这个消息。
```
```
//当然我们还可以随意增加或者删除订阅者，增加任何订阅者都不会影响发布者代码的编写：
document.body.addEventListener('click',function () {
    alert(3);
},false);
document.body.click();
```
注：手动触发事件更好的做法是IE下用fireEvent,标准浏览器下用dispatchEvent实现。
##### 自定义事件
除了dom事件，还可以实现一些自定义事件，这种靠自定义事件完成的发布-订阅模式可以用于任何js代码中。
如何实现发布-订阅模式？
1.首先要指定好谁充当发布者（如售楼处）
2.然后给发布者添加一个缓存列表，用于存放回调函数以便通知订阅者（如售楼处的花名册)。
3.最后发布消息的时候，发布者会遍历这个缓存列表，依次触发里面存放的订阅者回调函数（遍历花名册，挨个发短信）
另外，可以在回调函数里填入一些参数，订阅者可以接收这些参数。这是很有必要的，比如售楼处可以在发给订阅者的短信里面加上房子的一些信息，订阅者收到这些信息之后可以各自处理。
#### 真实例子——网站登录
假如正在开发一个商城网站，网站里面有header头部，nav导航，消息列表，购物车等模块。这几个模块的渲染有一个共同的前提条件，就必须先用ajax异步请求获取用户的登录信息。比如用户的名字和头像要显示在header模块里，而这两个字段都来自用户登录后返回的信息。
至于ajax请求什么时候能成功返回用户信息，这点我们不能确定。
用发布-订阅模式来写，有关用户信息业务的模块将自行订阅登录成功的消息事件，当登录成功时，登录模块只需要发布登录成功的消息，而业务方接受到消息之后，就会开始各自的业务处理，登录模块并不关心业务方究竟要做什么，也不想去了解他们的内部细节。
